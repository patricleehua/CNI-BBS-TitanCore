# Redis 配置文件 - CNI-BBS-TitanCore
# 基于 Redis 7.x

# ==================== 网络配置 ====================
# 绑定所有网卡（Docker 环境）
bind 0.0.0.0
# 保护模式关闭（Docker 内部网络）
protected-mode no
# 端口
port 6379
# TCP 连接队列长度
tcp-backlog 511
# 客户端超时时间（秒，0 表示禁用）
timeout 0
# TCP keepalive
tcp-keepalive 300

# ==================== 安全配置 ====================
# 密码认证（与项目配置保持一致）
# 默认密码：titan_bbs_2026
# 生产环境请修改为强密码
requirepass titan_bbs_2026

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ==================== 持久化配置 ====================
# RDB 快照
# 900 秒内至少 1 个 key 变化
save 900 1
# 300 秒内至少 10 个 key 变化
save 300 10
# 60 秒内至少 10000 个 key 变化
save 60 10000

# RDB 文件
dbfilename dump.rdb
dir /data
# 压缩
rdbcompression yes
# 校验
rdbchecksum yes

# AOF 持久化
appendonly yes
appendfilename "appendonly.aof"
# 同步策略：每秒同步一次（性能与安全的平衡）
appendfsync everysec
# 重写配置
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ==================== 内存管理 ====================
# 最大内存（根据实际情况调整）
maxmemory 512mb
# 内存淘汰策略：LRU 删除最近最少使用的 key
maxmemory-policy allkeys-lru
# 样本数量
maxmemory-samples 5

# ==================== 日志配置 ====================
# 日志级别：debug, verbose, notice, warning
loglevel notice
# 日志文件（Docker 使用 stdout）
logfile ""

# ==================== 客户端配置 ====================
# 最大客户端连接数
maxclients 10000

# ==================== 慢查询配置 ====================
# 慢查询阈值（微秒）：10ms
slowlog-log-slower-than 10000
# 慢查询日志长度
slowlog-max-len 128

# ==================== 数据库配置 ====================
# 数据库数量
databases 16

# ==================== 其他配置 ====================
# 守护进程模式（Docker 中必须为 no）
daemonize no
# PID 文件
pidfile /var/run/redis_6379.pid
# 总是显示 logo
always-show-logo yes
